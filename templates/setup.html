<!-- setup.html -->
{% extends "layout.html" %}

{% block content %}
        <div class="setupContainer">
          {% if status and status_message %}
            <p class="status-message {{ status }}">{{ status_message }}</p>
          {% endif %}

          {% if "API key" in setup_message %}
            <div class="setupSection">
              <h3>Setup Required</h3>
              <p class="setupMessage">{{ setup_message }}</p>
              <form action="{{ url_for('set_openai_api_key') }}" method="POST">
                <div class="inputWrapper">
                  <input 
                    type="text"
                    name="api_key"
                    placeholder="sk-..."
                    required
                    class="input"
                    autocomplete="off"
                    autocapitalize="off"
                    spellcheck="false"
                    aria-label="OpenAI API key"
                  >
                </div>
                <button 
                  type="submit"
                  class="button"
                >
                  Save API Key
                </button>
              </form>
            </div>
          {% else %}
              <div class="setupSection">
                <h3>Save App Configuration</h3>

                <form action="{{ url_for('save_app_config') }}" method="POST">
                  <div>
                    <label for="model-select">Select Model:</label>
                    <select name="model" id="model-select" class="input" required>
                      {% if available_models %}
                        {% for model_id in available_models %}
                          <option value="{{ model_id }}" {% if model_id == current_model %}selected{% endif %}>{{ model_id }}</option>
                        {% endfor %}
                      {% else %}
                        <option value="" disabled>Could not load models</option>
                        {# Optionally include a default fallback if loading fails #}
                        {% if current_model %}
                          <option value="{{ current_model }}" selected>{{ current_model }} (current)</option>
                        {% else %}
                           <option value="gpt-4o" selected>gpt-4o (default)</option> {# Default fallback #}
                        {% endif %}
                      {% endif %}
                    </select>
                  </div>
                  
                  <div style="margin-top: 15px;">
                    <label for="instructions-input">System Prompt:</label>
                    <textarea 
                      name="instructions" 
                      id="instructions-input" 
                      class="input" 
                      rows="4" 
                      placeholder="e.g., You are a helpful assistant."
                      style="width: 100%; resize: none;"
                    >{% if current_instructions %}{{ current_instructions }}{% else %}You are a helpful assistant.{% endif %}</textarea>
                  </div>

                  <div style="margin-top: 15px;">
                    <label>
                      <input type="checkbox" name="show_tool_call_detail" value="true" {% if current_show_tool_call_detail %}checked{% endif %}>
                      Show tool call detail in responses
                    </label>
                  </div>

                  <p class="setupMessage" style="margin-top: 15px;">Select tools for your assistant:</p>
                  <div>
                    <label>
                      <input type="checkbox" name="tool_types" value="code_interpreter" {% if "code_interpreter" in current_tools %}checked{% endif %}>
                      Code Interpreter
                    </label>
                    <label>
                      <input type="checkbox" name="tool_types" value="file_search" {% if "file_search" in current_tools %}checked{% endif %}>
                      File Search
                    </label>
                    <label>
                      <input type="checkbox" name="tool_types" value="function" {% if "function" in current_tools %}checked{% endif %}>
                      Custom Functions
                    </label>
                    <label>
                      <input type="checkbox" name="tool_types" value="mcp" {% if "mcp" in current_tools %}checked{% endif %}>
                      MCP Tools
                    </label>
                  </div>
                  <div class="centered-button-container">
                    <button 
                      type="submit"
                      class="button"
                    >
                      Save Configuration
                    </button>
                  </div>
                </form>
              </div>
              {% if "file_search" in current_tools %}
                <div class="setupSection" style="margin-top: 20px;">
                    {% include 'components/file-viewer.html' %}
                </div>
              {% endif %}
              {% if "function" in current_tools %}
                <div class="setupSection" style="margin-top: 20px;">
                  <h3>Register Custom Functions</h3>
                  <p class="setupMessage">Provide function entries to include in <code>tool.config.json</code>. Use module import path for functions and a template path relative to the <code>templates/</code> directory (e.g., <code>components/weather-widget.html</code>). If you paste a path beginning with <code>templates/</code>, it will be normalized automatically.</p>

                  <form action="{{ url_for('save_app_config') }}" method="POST" id="registry-form">
                    <input type="hidden" name="action" value="regenerate_registry">

                    <div id="registry-rows">
                      {% if existing_registry_entries %}
                        {% for entry in existing_registry_entries %}
                          {% set index = loop.index0 %}
                          {% set name = entry.name %}
                          {% set import_path = entry.import_path %}
                          {% set template_path = entry.template_path %}
                          {% include 'components/registry-row.html' %}
                        {% endfor %}
                      {% else %}
                        {% set index = 0 %}
                        {% include 'components/registry-row.html' %}
                      {% endif %}
                    </div>

                    <div style="display:flex; gap: 10px;">
                      <button type="button" class="button" hx-get="{{ url_for('new_registry_row') }}" hx-target="#registry-rows" hx-swap="beforeend" hx-include="#registry-rows input[name='reg_function_names'], #registry-rows input[name='reg_import_paths'], #registry-rows input[name='reg_template_paths']">Add Function</button>
                      <button type="submit" class="button">Regenerate tool.config.json</button>
                    </div>
                  </form>
                </div>
                
              {% endif %}
              {% if "mcp" in current_tools %}
                <div class="setupSection" style="margin-top: 20px;">
                  <h3>Register MCP Servers</h3>
                  <p class="setupMessage">Add MCP servers to include in <code>tool.config.json</code>. Provide a label and either a server URL or a connector ID.</p>

                  <form action="{{ url_for('save_app_config') }}" method="POST" id="mcp-form">
                    <input type="hidden" name="action" value="regenerate_registry">

                    <div id="mcp-rows">
                      {% if existing_mcp_servers %}
                        {% for srv in existing_mcp_servers %}
                          {% set index = loop.index0 %}
                          {% set label = srv.server_label %}
                          {% set server_url = srv.server_url if 'server_url' in srv else '' %}
                          {% set connector_id = srv.connector_id if 'connector_id' in srv else '' %}
                          {% set authorization = srv.authorization if 'authorization' in srv else '' %}
                          {% set headers_json = srv.headers_json if 'headers_json' in srv else '' %}
                          {% include 'components/mcp-row.html' %}
                        {% endfor %}
                      {% else %}
                        {% set index = 0 %}
                        {% include 'components/mcp-row.html' %}
                      {% endif %}
                    </div>

                    <div style="display:flex; gap: 10px;">
                      <button type="button" class="button" hx-get="{{ url_for('new_mcp_row') }}" hx-target="#mcp-rows" hx-swap="beforeend" hx-include="#mcp-rows input[name='mcp_labels'], #mcp-rows input[name='mcp_server_urls'], #mcp-rows input[name='mcp_connector_ids'], #mcp-rows input[name='mcp_authorizations'], #mcp-rows textarea[name='mcp_headers_jsons']">Add MCP Server</button>
                      <button type="submit" class="button">Regenerate tool.config.json</button>
                    </div>
                  </form>
                </div>
              {% endif %}
          {% endif %}
        </div>
{% endblock %}